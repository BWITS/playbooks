---
# ---------------------------------------------------------
# Called by other roles to register a host with SkyDNS
# ---------------------------------------------------------
- debug: msg="Sending registration request to '{{ etcd_host }}' for '{{ host }}' => '{{ ip }}'"
- debug: msg="etcd_port = '{{ etcd_port }}'"
- debug: msg="skydns_host = '{{ skydns_host }}'"

- set_fact: registration_url="http://{{ etcd_host }}:{{ etcd_port }}/v2/keys/skydns/{{ '/'.join( host.split( '.' )[::-1] ) }}"

# https://github.com/ansible/ansible-modules-core/issues/265
# uri:
#   method:  PUT
#   url:     "{{ registration_url }}"
#   body:    "{ 'host' : '{{ ip }}' }"
#   timeout: 3

- include: "{{ common.utils.run }}"
  vars:
    title: Registration checks
    commands:
      - { run: "curl -XPUT '{{ registration_url }}' -d value='{\"host\":\"{{ ip }}\"}'" }
      - { run: "dig @{{ skydns_host }} '{{ host }}'", expect: '{{ host }}.	3600	IN	A	{{ ip }}' }
