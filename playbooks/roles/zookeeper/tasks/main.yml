---
- set_fact:
    zookeeper_home: "{{ zookeeper.home }}/zookeeper-{{ zookeeper.version }}"
    zookeeper_port: "{{ zookeeper_port | default( zookeeper.port ) }}"

- include: "{{ common.utils.service }}"
  vars:
    title:    ZooKeeper
    service:  zookeeper
    url:     "{{ zookeeper.url     | tokens( zookeeper ) }}"
    archive: "{{ zookeeper.archive | tokens( zookeeper ) }}"
    home:    "{{ zookeeper.home }}"
    configs:
      - { from: zoo.cfg, to: "{{ zookeeper_home }}/conf/zoo.cfg" }
    env:
      PATH:  "$PATH:{{ zookeeper_home }}/bin"
    command: "{{ zookeeper_home }}/bin/zkServer.sh start-foreground"
    port:    "{{ zookeeper_port }}"

- include: "{{ common.utils.run }}"
  vars:
    title: zkCli check
    commands:
      - { run:    "echo 'ls /' | '{{ zookeeper_home }}/bin/zkCli.sh' -server '{{ common.net.localhost }}:{{ zookeeper_port }}'",
          expect: '{{ common.net.localhost }}:{{ zookeeper_port }}(CONNECTED)' }
