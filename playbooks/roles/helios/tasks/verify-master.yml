---
# ---------------------------------------------------------
#   Verifies connectivity with Helios master and services
# ---------------------------------------------------------
- debug: msg="Verifying Helios master '{{ master }}' endpoints"

- set_fact: zk_shell_command="echo 'ls /' | zk-shell '{{ master }}:{{ zookeeper_port }}' --run-from-stdin"

- include: "{{ common.utils.verify }}"
  vars:
    title: Helios master DNS and ZooKepper
    host:  "{{ master }}"
    ports:
      - "{{ common.net.ports.dns }}"
      - "{{ zookeeper_port }}"

- include: "{{ common.utils.verify }}"
  vars:
    title: Helios master service
    host:  "{{ master }}"
    port:  "{{ helios_master_port }}"
    verify:
      - { status: 404 }

- include: "{{ common.utils.verify }}"
  vars:
    title: Helios master etcd
    host:  "{{ master }}"
    port:  "{{ etcd_port }}"
    verify:
      - { path: /version,         content: '"releaseVersion":' }
      - { path: /v2/stats/leader, content: '{"leader":"' }

- name: Runing zk-shell
  shell:    "{{ zk_shell_command }}"
  register: zk_shell

- fail: msg="Running [{{ zk_shell_command }}] - 'zookeeper' is not in [{{ zk_shell.stdout }}]"
  when: not ( 'zookeeper' in zk_shell.stdout )

- set_fact: my_ip="{{ facter_ipaddress_eth1 | default( ansible_default_ipv4.address )}}"
#                         VirtualBox                              AWS
- debug:    msg="My IP is [{{ my_ip }}]"

- include: "{{ common.utils.register }}"
  vars:
    etcd_host:   "{{ master }}"
    skydns_host: "{{ master }}"
    fqdn:        "{{ ansible_fqdn }}"
    ip:          "{{ my_ip }}"
